<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认识钟表学习工具</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid currentColor;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Simple SVG Icons to replace lucide-react in standalone HTML
        const Icons = {
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Gamepad2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="15" y1="13" x2="15.01" y2="13"/><line x1="18" y1="11" x2="18.01" y2="11"/></svg>,
            RotateCcw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><polyline points="3 3 3 8 8 8"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>,
            Volume2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>,
            MessageSquareText: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M13 8H7"/><path d="M17 12H7"/></svg>,
            Loader2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></svg>
        };

        const App = () => {
            const [time, setTime] = useState(new Date());
            const [isManual, setIsManual] = useState(false);
            const [manualHours, setManualHours] = useState(10);
            const [manualMinutes, setManualMinutes] = useState(10);
            const [view, setView] = useState('explore'); 
            const [quizTask, setQuizTask] = useState({ h: 3, m: 0 });
            const [feedback, setFeedback] = useState(null);
            const [aiStory, setAiStory] = useState('');
            const [isGeneratingStory, setIsGeneratingStory] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const apiKey = ""; // 运行时自动注入

            useEffect(() => {
                if (!isManual && view === 'explore') {
                    const timer = setInterval(() => setTime(new Date()), 1000);
                    return () => clearInterval(timer);
                }
            }, [isManual, view]);

            const h = isManual ? manualHours : time.getHours();
            const m = isManual ? manualMinutes : time.getMinutes();
            const s = isManual ? 0 : time.getSeconds();

            const hourDeg = (h % 12) * 30 + m * 0.5;
            const minDeg = m * 6;
            const secDeg = s * 6;

            const callGemini = async (url, payload, retries = 5, delay = 1000) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) return await response.json();
                    } catch (e) {
                        if (i === retries - 1) throw e;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            };

            const generateTimeStory = async () => {
                setIsGeneratingStory(true);
                setAiStory('');
                const prompt = `现在是钟表上的 ${h}点${m}分。请为一个小孩子写一个非常简短（2句话以内）的有趣小故事，描述这个时间点通常在发生什么。语气要亲切、生动。`;
                try {
                    const result = await callGemini(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: "你是一位温和的幼儿园老师，擅长给孩子们讲时间的故事。" }] }
                        }
                    );
                    setAiStory(result.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (error) {
                    setAiStory("哎呀，魔法暂时失灵了，请稍后再试吧！");
                } finally {
                    setIsGeneratingStory(false);
                }
            };

            const playTts = async () => {
                setIsSpeaking(true);
                const textToSay = `现在是 ${h}点 ${m === 0 ? '整' : m + '分'}。`;
                try {
                    const result = await callGemini(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
                        {
                            contents: [{ parts: [{ text: `Say warmly: ${textToSay}` }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                            },
                            model: "gemini-2.5-flash-preview-tts"
                        }
                    );
                    const audioData = result.candidates[0].content.parts[0].inlineData.data;
                    const audioBlob = pcmToWav(audioData, 24000);
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.onended = () => setIsSpeaking(false);
                    await audio.play();
                } catch (error) {
                    setIsSpeaking(false);
                }
            };

            const pcmToWav = (base64Pcm, sampleRate) => {
                const binaryString = window.atob(base64Pcm);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
                const wavHeader = new ArrayBuffer(44);
                const view = new DataView(wavHeader);
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
                };
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + len, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, len, true);
                return new Blob([wavHeader, bytes], { type: 'audio/wav' });
            };

            const generateQuiz = () => {
                const hours = Math.floor(Math.random() * 12) || 12;
                const minutes = [0, 15, 30, 45][Math.floor(Math.random() * 4)];
                setQuizTask({ h: hours, m: minutes });
                setManualHours(12);
                setManualMinutes(0);
                setFeedback(null);
                setAiStory('');
            };

            const checkQuiz = () => {
                if (manualHours % 12 === quizTask.h % 12 && manualMinutes === quizTask.m) {
                    setFeedback({ type: 'success', text: '太棒了！完全正确！' });
                } else {
                    setFeedback({ type: 'error', text: '不对哦，再试着调一下吧。' });
                }
            };

            const Hand = ({ deg, length, width, color, opacity = 1 }) => (
                <div
                    className="absolute transition-transform duration-500 ease-out"
                    style={{
                        width: `${width}px`,
                        height: `${length}px`,
                        backgroundColor: color,
                        bottom: '50%',
                        left: '50%',
                        transformOrigin: 'bottom center',
                        transform: `translateX(-50%) rotate(${deg}deg)`,
                        borderRadius: '10px',
                        opacity: opacity
                    }}
                />
            );

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 flex flex-col items-center font-sans text-slate-800">
                    <div className="max-w-4xl w-full flex flex-col lg:flex-row gap-6">
                        <div className="flex-1 bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
                            <div className="bg-indigo-600 p-6 text-white flex justify-between items-center">
                                <h1 className="text-2xl font-bold flex items-center gap-2">
                                    <Icons.Clock /> 认识钟表
                                </h1>
                                <div className="flex bg-indigo-700 rounded-lg p-1">
                                    <button onClick={() => { setView('explore'); setIsManual(false); setAiStory(''); }} className={`px-3 py-1.5 rounded-md transition text-sm ${view === 'explore' ? 'bg-white text-indigo-600 shadow' : 'text-white hover:bg-indigo-500'}`}><div className="flex items-center gap-2 font-medium"><Icons.BookOpen /> 自由探索</div></button>
                                    <button onClick={() => { setView('quiz'); setIsManual(true); generateQuiz(); }} className={`px-3 py-1.5 rounded-md transition text-sm ${view === 'quiz' ? 'bg-white text-indigo-600 shadow' : 'text-white hover:bg-indigo-500'}`}><div className="flex items-center gap-2 font-medium"><Icons.Gamepad2 /> 挑战练习</div></button>
                                </div>
                            </div>

                            <div className="p-6 flex flex-col items-center">
                                <div className="relative w-64 h-64 md:w-72 md:h-72 bg-white border-[10px] border-slate-800 rounded-full shadow-inner flex items-center justify-center my-4">
                                    <div className="absolute w-4 h-4 bg-slate-800 rounded-full z-40" />
                                    {[...Array(12)].map((_, i) => (
                                        <div key={i} className="absolute inset-2 text-center" style={{ transform: `rotate(${(i + 1) * 30}deg)` }}>
                                            <span className="inline-block font-black text-xl md:text-2xl" style={{ transform: `rotate(-${(i + 1) * 30}deg)` }}>{i + 1}</span>
                                        </div>
                                    ))}
                                    {[...Array(60)].map((_, i) => (
                                        <div key={i} className="absolute w-1 bg-slate-300" style={{ height: i % 5 === 0 ? '10px' : '5px', bottom: '50%', left: '50%', transformOrigin: 'bottom center', transform: `translateX(-50%) rotate(${i * 6}deg) translateY(-${i % 5 === 0 ? 105 : 110}px)` }} />
                                    ))}
                                    <Hand deg={hourDeg} length={60} width={8} color="#1e293b" />
                                    <Hand deg={minDeg} length={90} width={5} color="#4f46e5" />
                                    {!isManual && view === 'explore' && <Hand deg={secDeg} length={100} width={2} color="#ef4444" />}
                                </div>

                                <div className="flex items-center gap-4 mb-6">
                                    <div className="bg-slate-100 px-6 py-2 rounded-2xl text-3xl font-mono font-black text-slate-700">{h.toString().padStart(2, '0')}:{m.toString().padStart(2, '0')}</div>
                                    <button onClick={playTts} disabled={isSpeaking} className={`p-3 rounded-full shadow-md transition ${isSpeaking ? 'bg-indigo-100 text-indigo-400' : 'bg-indigo-500 text-white hover:bg-indigo-600 active:scale-95'}`}>
                                        {isSpeaking ? <Icons.Loader2 /> : <Icons.Volume2 />}
                                    </button>
                                </div>

                                <div className="w-full max-w-sm space-y-4">
                                    {view === 'explore' ? (
                                        <div className="pt-4 border-t border-slate-100">
                                            <label className="flex items-center gap-2 cursor-pointer mb-4 justify-center">
                                                <input type="checkbox" className="w-5 h-5 accent-indigo-600" checked={isManual} onChange={(e) => setIsManual(e.target.checked)} />
                                                <span className="font-medium text-slate-700">手动调节模式</span>
                                            </label>
                                            {isManual && (
                                                <div className="space-y-4 px-4">
                                                    <input type="range" min="0" max="11" value={manualHours} onChange={(e) => setManualHours(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800 text-slate-800" />
                                                    <input type="range" min="0" max="59" value={manualMinutes} onChange={(e) => setManualMinutes(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600 text-indigo-600" />
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-center">
                                                <p className="text-xs text-indigo-700 font-bold uppercase mb-1">目标时间</p>
                                                <p className="text-3xl font-black text-indigo-600">{quizTask.h}:{quizTask.m === 0 ? '00' : quizTask.m}</p>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <button onClick={() => setManualHours(prev => (prev > 1 ? prev - 1 : 12))} className="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 flex justify-center"><Icons.ChevronLeft/></button>
                                                <button onClick={() => setManualHours(prev => (prev < 12 ? prev + 1 : 1))} className="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 flex justify-center"><Icons.ChevronRight/></button>
                                            </div>
                                            <button onClick={checkQuiz} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition">检查结果</button>
                                            {feedback && <div className={`p-3 rounded-lg text-center font-bold text-sm ${feedback.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{feedback.text}</div>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="w-full lg:w-80 space-y-6">
                            <div className="bg-white rounded-3xl shadow-lg border border-indigo-100 overflow-hidden">
                                <div className="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2 text-indigo-900">
                                    <Icons.Sparkles className="text-indigo-600" /> <h2 className="font-bold">✨ AI 智慧助手</h2>
                                </div>
                                <div className="p-5 space-y-4">
                                    <p className="text-sm text-slate-600">让 AI 为你编一个时间小故事吧！</p>
                                    <button onClick={generateTimeStory} disabled={isGeneratingStory} className="w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold rounded-xl shadow-lg disabled:opacity-50">
                                        {isGeneratingStory ? <Icons.Loader2 /> : <Icons.MessageSquareText />} ✨ 生成时间故事
                                    </button>
                                    {aiStory && <div className="mt-4 p-4 bg-amber-50 rounded-2xl border-l-4 border-amber-400"><p className="text-sm text-amber-900 italic font-medium">"{aiStory}"</p></div>}
                                </div>
                            </div>
                            <div className="bg-slate-800 rounded-3xl p-6 text-white shadow-xl text-xs space-y-3">
                                <h3 className="font-bold mb-3 flex items-center gap-2"><Icons.BookOpen size={16}/> 学习笔记</h3>
                                <div className="flex gap-2"><span className="text-indigo-400 font-bold">整点:</span><span>分针指 12，时针指几就是几点。</span></div>
                                <div className="flex gap-2"><span className="text-indigo-400 font-bold">半点:</span><span>分针指 6，时针在两数中间。</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
