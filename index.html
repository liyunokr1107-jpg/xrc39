import React, { useState, useEffect, useRef } from 'react';
import { Clock, BookOpen, Gamepad2, RotateCcw, ChevronLeft, ChevronRight, Sparkles, Volume2, MessageSquareText, Loader2 } from 'lucide-react';

const App = () => {
  const [time, setTime] = useState(new Date());
  const [isManual, setIsManual] = useState(false);
  const [manualHours, setManualHours] = useState(10);
  const [manualMinutes, setManualMinutes] = useState(10);
  const [view, setView] = useState('explore'); // 'explore' or 'quiz'
  const [quizTask, setQuizTask] = useState({ h: 3, m: 0 });
  const [feedback, setFeedback] = useState(null);
  
  // AI States
  const [aiStory, setAiStory] = useState('');
  const [isGeneratingStory, setIsGeneratingStory] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const apiKey = ""; // Runtime provided

  // å®æ—¶æ—¶é’Ÿé€»è¾‘
  useEffect(() => {
    if (!isManual && view === 'explore') {
      const timer = setInterval(() => setTime(new Date()), 1000);
      return () => clearInterval(timer);
    }
  }, [isManual, view]);

  const h = isManual ? manualHours : time.getHours();
  const m = isManual ? manualMinutes : time.getMinutes();
  const s = isManual ? 0 : time.getSeconds();

  // è®¡ç®—è§’åº¦
  const hourDeg = (h % 12) * 30 + m * 0.5;
  const minDeg = m * 6;
  const secDeg = s * 6;

  // Gemini API Helper with Backoff
  const callGemini = async (url, payload, retries = 5, delay = 1000) => {
    for (let i = 0; i < retries; i++) {
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (response.ok) return await response.json();
      } catch (e) {
        if (i === retries - 1) throw e;
      }
      await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
    }
  };

  // âœ¨ AI Feature: Generate Story
  const generateTimeStory = async () => {
    setIsGeneratingStory(true);
    setAiStory('');
    const prompt = `ç°åœ¨æ˜¯é’Ÿè¡¨ä¸Šçš„ ${h}ç‚¹${m}åˆ†ã€‚è¯·ä¸ºä¸€ä¸ªå°å­©å­å†™ä¸€ä¸ªéå¸¸ç®€çŸ­ï¼ˆ2å¥è¯ä»¥å†…ï¼‰çš„æœ‰è¶£å°æ•…äº‹ï¼Œæè¿°è¿™ä¸ªæ—¶é—´ç‚¹é€šå¸¸åœ¨å‘ç”Ÿä»€ä¹ˆã€‚è¯­æ°”è¦äº²åˆ‡ã€ç”ŸåŠ¨ã€‚`;
    
    try {
      const result = await callGemini(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: "ä½ æ˜¯ä¸€ä½æ¸©å’Œçš„å¹¼å„¿å›­è€å¸ˆï¼Œæ“…é•¿ç»™å­©å­ä»¬è®²æ—¶é—´çš„æ•…äº‹ã€‚" }] }
        }
      );
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiStory(text);
    } catch (error) {
      setAiStory("å“å‘€ï¼Œé­”æ³•æš‚æ—¶å¤±çµäº†ï¼Œè¯·ç¨åå†è¯•å§ï¼");
    } finally {
      setIsGeneratingStory(false);
    }
  };

  // âœ¨ AI Feature: Text to Speech
  const playTts = async () => {
    setIsSpeaking(true);
    const textToSay = `ç°åœ¨æ˜¯ ${h}ç‚¹ ${m === 0 ? 'æ•´' : m + 'åˆ†'}ã€‚`;
    
    try {
      const result = await callGemini(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
        {
          contents: [{ parts: [{ text: `Say warmly: ${textToSay}` }] }],
          generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
          },
          model: "gemini-2.5-flash-preview-tts"
        }
      );

      const audioData = result.candidates[0].content.parts[0].inlineData.data;
      const audioBlob = pcmToWav(audioData, 24000); // Standard sample rate
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);
      audio.onended = () => setIsSpeaking(false);
      await audio.play();
    } catch (error) {
      setIsSpeaking(false);
    }
  };

  // Helper: PCM to WAV
  const pcmToWav = (base64Pcm, sampleRate) => {
    const binaryString = window.atob(base64Pcm);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
    
    const wavHeader = new ArrayBuffer(44);
    const view = new DataView(wavHeader);
    const writeString = (offset, string) => {
      for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
    };

    writeString(0, 'RIFF');
    view.setUint32(4, 36 + len, true);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeString(36, 'data');
    view.setUint32(40, len, true);

    const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
    return blob;
  };

  const generateQuiz = () => {
    const hours = Math.floor(Math.random() * 12) || 12;
    const minutes = [0, 15, 30, 45][Math.floor(Math.random() * 4)];
    setQuizTask({ h: hours, m: minutes });
    setManualHours(12);
    setManualMinutes(0);
    setFeedback(null);
    setAiStory('');
  };

  const checkQuiz = () => {
    if (manualHours % 12 === quizTask.h % 12 && manualMinutes === quizTask.m) {
      setFeedback({ type: 'success', text: 'å¤ªæ£’äº†ï¼å®Œå…¨æ­£ç¡®ï¼' });
    } else {
      setFeedback({ type: 'error', text: 'ä¸å¯¹å“¦ï¼Œå†è¯•ç€è°ƒä¸€ä¸‹å§ã€‚' });
    }
  };

  const Hand = ({ deg, length, width, color, opacity = 1 }) => (
    <div
      className="absolute transition-transform duration-500 ease-out"
      style={{
        width: `${width}px`,
        height: `${length}px`,
        backgroundColor: color,
        bottom: '50%',
        left: '50%',
        transformOrigin: 'bottom center',
        transform: `translateX(-50%) rotate(${deg}deg)`,
        borderRadius: '10px',
        opacity: opacity
      }}
    />
  );

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 flex flex-col items-center font-sans text-slate-800">
      <div className="max-w-4xl w-full flex flex-col lg:flex-row gap-6">
        
        {/* Main Clock Card */}
        <div className="flex-1 bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
          <div className="bg-indigo-600 p-6 text-white flex justify-between items-center">
            <div>
              <h1 className="text-2xl font-bold flex items-center gap-2">
                <Clock className="w-8 h-8" /> è®¤è¯†é’Ÿè¡¨
              </h1>
            </div>
            <div className="flex bg-indigo-700 rounded-lg p-1">
              <button 
                onClick={() => { setView('explore'); setIsManual(false); setAiStory(''); }}
                className={`px-3 py-1.5 rounded-md transition text-sm ${view === 'explore' ? 'bg-white text-indigo-600 shadow' : 'text-white hover:bg-indigo-500'}`}
              >
                <div className="flex items-center gap-2 font-medium"><BookOpen size={16}/> è‡ªç”±æ¢ç´¢</div>
              </button>
              <button 
                onClick={() => { setView('quiz'); setIsManual(true); generateQuiz(); }}
                className={`px-3 py-1.5 rounded-md transition text-sm ${view === 'quiz' ? 'bg-white text-indigo-600 shadow' : 'text-white hover:bg-indigo-500'}`}
              >
                <div className="flex items-center gap-2 font-medium"><Gamepad2 size={16}/> æŒ‘æˆ˜ç»ƒä¹ </div>
              </button>
            </div>
          </div>

          <div className="p-6 flex flex-col items-center">
            {/* Clock Viewport */}
            <div className="relative w-64 h-64 md:w-72 md:h-72 bg-white border-[10px] border-slate-800 rounded-full shadow-inner flex items-center justify-center my-4">
              <div className="absolute w-4 h-4 bg-slate-800 rounded-full z-40" />
              {[...Array(12)].map((_, i) => {
                const angle = (i + 1) * 30;
                return (
                  <div key={i} className="absolute inset-2 text-center" style={{ transform: `rotate(${angle}deg)` }}>
                    <span className="inline-block font-black text-xl md:text-2xl" style={{ transform: `rotate(-${angle}deg)` }}>
                      {i + 1}
                    </span>
                  </div>
                );
              })}
              {[...Array(60)].map((_, i) => (
                <div key={i} className="absolute w-1 bg-slate-300" style={{ height: i % 5 === 0 ? '10px' : '5px', bottom: '50%', left: '50%', transformOrigin: 'bottom center', transform: `translateX(-50%) rotate(${i * 6}deg) translateY(-${i % 5 === 0 ? 105 : 110}px)` }} />
              ))}
              <Hand deg={hourDeg} length={60} width={8} color="#1e293b" />
              <Hand deg={minDeg} length={90} width={5} color="#4f46e5" />
              {!isManual && view === 'explore' && <Hand deg={secDeg} length={100} width={2} color="#ef4444" />}
            </div>

            {/* Time Digital Display & TTS */}
            <div className="flex items-center gap-4 mb-6">
              <div className="bg-slate-100 px-6 py-2 rounded-2xl text-3xl font-mono font-black text-slate-700">
                {h.toString().padStart(2, '0')}:{m.toString().padStart(2, '0')}
              </div>
              <button 
                onClick={playTts}
                disabled={isSpeaking}
                className={`p-3 rounded-full shadow-md transition ${isSpeaking ? 'bg-indigo-100 text-indigo-400' : 'bg-indigo-500 text-white hover:bg-indigo-600 active:scale-95'}`}
                title="AI æŠ¥æ—¶"
              >
                {isSpeaking ? <Loader2 className="animate-spin" /> : <Volume2 />}
              </button>
            </div>

            {/* Controls */}
            <div className="w-full max-w-sm space-y-4">
              {view === 'explore' ? (
                <div className="pt-4 border-t border-slate-100">
                   <label className="flex items-center gap-2 cursor-pointer mb-4 justify-center">
                    <input type="checkbox" className="w-5 h-5 accent-indigo-600" checked={isManual} onChange={(e) => setIsManual(e.target.checked)} />
                    <span className="font-medium text-slate-700">æ‰‹åŠ¨è°ƒèŠ‚æ¨¡å¼</span>
                  </label>
                  {isManual && (
                    <div className="space-y-4 px-4">
                      <input type="range" min="0" max="11" value={manualHours} onChange={(e) => setManualHours(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-800" />
                      <input type="range" min="0" max="59" value={manualMinutes} onChange={(e) => setManualMinutes(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                    </div>
                  )}
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-center">
                    <p className="text-xs text-indigo-700 font-bold uppercase mb-1">ç›®æ ‡æ—¶é—´</p>
                    <p className="text-3xl font-black text-indigo-600">{quizTask.h}:{quizTask.m === 0 ? '00' : quizTask.m}</p>
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    <button onClick={() => setManualHours(prev => (prev > 1 ? prev - 1 : 12))} className="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 flex justify-center"><ChevronLeft/></button>
                    <button onClick={() => setManualHours(prev => (prev < 12 ? prev + 1 : 1))} className="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 flex justify-center"><ChevronRight/></button>
                  </div>
                  <button onClick={checkQuiz} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition">æ£€æŸ¥ç»“æœ</button>
                  {feedback && <div className={`p-3 rounded-lg text-center font-bold text-sm ${feedback.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{feedback.text}</div>}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* AI Assistant Sidebar */}
        <div className="w-full lg:w-80 space-y-6">
          <div className="bg-white rounded-3xl shadow-lg border border-indigo-100 overflow-hidden">
            <div className="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2">
              <Sparkles className="text-indigo-600 w-5 h-5" />
              <h2 className="font-bold text-indigo-900">âœ¨ AI æ™ºæ…§åŠ©æ‰‹</h2>
            </div>
            <div className="p-5 space-y-4">
              <p className="text-sm text-slate-600 leading-relaxed">
                æƒ³çŸ¥é“è¿™ä¸ªæ—¶é—´åœ¨å‘ç”Ÿä»€ä¹ˆå—ï¼Ÿè®© AI ä¸ºä½ ç¼–ä¸€ä¸ªæ—¶é—´å°æ•…äº‹å§ï¼
              </p>
              
              <button 
                onClick={generateTimeStory}
                disabled={isGeneratingStory}
                className="w-full flex items-center justify-center gap-2 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold rounded-xl hover:opacity-90 transition shadow-lg disabled:opacity-50"
              >
                {isGeneratingStory ? <Loader2 className="animate-spin w-5 h-5" /> : <MessageSquareText size={18} />}
                âœ¨ ç”Ÿæˆæ—¶é—´æ•…äº‹
              </button>

              {aiStory && (
                <div className="mt-4 p-4 bg-amber-50 rounded-2xl border-l-4 border-amber-400 animate-in fade-in slide-in-from-top-2 duration-500">
                  <p className="text-sm text-amber-900 italic leading-relaxed font-medium">
                    "{aiStory}"
                  </p>
                </div>
              )}
            </div>
          </div>

          <div className="bg-slate-800 rounded-3xl p-6 text-white shadow-xl">
             <h3 className="font-bold mb-3 flex items-center gap-2">ğŸ’¡ å­¦ä¹ ç¬”è®°</h3>
             <div className="space-y-3 text-xs opacity-90">
               <div className="flex gap-2">
                 <span className="text-indigo-400 font-bold">æ•´ç‚¹:</span>
                 <span>åˆ†é’ˆæŒ‡ç€ 12ï¼Œæ—¶é’ˆæŒ‡ç€å‡ å°±æ˜¯å‡ ç‚¹ã€‚</span>
               </div>
               <div className="flex gap-2">
                 <span className="text-indigo-400 font-bold">åŠç‚¹:</span>
                 <span>åˆ†é’ˆæŒ‡ç€ 6ï¼Œæ—¶é’ˆåœ¨ä¸¤ä¸ªæ•°å­—ä¸­é—´ã€‚</span>
               </div>
               <div className="flex gap-2">
                 <span className="text-indigo-400 font-bold">å£è¯€:</span>
                 <span>å°å°æ•°å­—çœ‹æ—¶é’ˆï¼Œå¤§å¤§æ ¼ç‚¹æ•°åˆ†é’ˆã€‚</span>
               </div>
             </div>
          </div>
        </div>

      </div>
    </div>
  );
};

export default App;
